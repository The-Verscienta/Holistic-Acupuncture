/**
 * Generate 301 redirects from /:slug to /conditions/:slug for every condition in Sanity.
 * Used so old URLs like /headaches continue to work and redirect to /conditions/headaches.
 *
 * Writes public/_redirects (Netlify/Cloudflare Pages format).
 * Run at prebuild so the file is in dist when deploying.
 *
 * Requires: PUBLIC_SANITY_PROJECT_ID, PUBLIC_SANITY_DATASET in .env (token optional for read).
 */

import { createClient } from '@sanity/client';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';

dotenv.config();

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const REDIRECTS_PATH = path.join(__dirname, '../public/_redirects');

// Do not redirect these paths (real pages or reserved)
const RESERVED_SLUGS = new Set([
  'about', 'contact', 'conditions', 'blog', 'services', 'reviews', 'team', 'faq',
  'acupuncture', 'privacy', 'terms', 'admin', 'api', '404', 'index',
  'assets', '_astro', 'cloudflare-images-index', 'sitemap', 'sitemap-index',
]);

async function main() {
  const projectId = process.env.PUBLIC_SANITY_PROJECT_ID;
  const dataset = process.env.PUBLIC_SANITY_DATASET || 'production';
  if (!projectId) {
    console.warn('generate-condition-redirects: PUBLIC_SANITY_PROJECT_ID not set, writing empty redirects.');
    fs.writeFileSync(REDIRECTS_PATH, '# No condition redirects (Sanity not configured)\n', 'utf-8');
    return;
  }

  const client = createClient({
    projectId,
    dataset,
    apiVersion: '2024-01-01',
    useCdn: true,
  });

  const conditions = await client.fetch(
    `*[_type == "condition" && defined(slug.current)] { "slug": slug.current }`
  );

  const lines = [
    '# 301 redirects: old condition URLs (e.g. /headaches) -> /conditions/:slug',
    '# Generated by scripts/generate-condition-redirects.js',
    '',
  ];

  let count = 0;
  for (const { slug } of conditions) {
    if (!slug || RESERVED_SLUGS.has(slug)) continue;
    lines.push(`/${slug}  /conditions/${slug}  301`);
    count++;
  }

  const content = lines.join('\n') + (lines[lines.length - 1] === '' ? '' : '\n');
  fs.writeFileSync(REDIRECTS_PATH, content, 'utf-8');
  console.log(`Wrote ${count} condition redirect(s) to public/_redirects`);
}

main().catch((err) => {
  console.error('generate-condition-redirects failed:', err);
  process.exit(1);
});
