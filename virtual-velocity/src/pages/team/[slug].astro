---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Container from '../../components/Container.astro';
import Card from '../../components/Card.astro';
import Badge from '../../components/Badge.astro';
import Button from '../../components/Button.astro';
import SanityImage from '../../components/SanityImage.astro';
import { getAllTeamMembers, getTeamMemberBySlug } from '../../lib/sanityQueries';
import { JANE_BOOKING_URL, CONTACT } from '../../lib/config';
import { escapeHtml } from '../../lib/sanitize';

export async function getStaticPaths() {
  const members = await getAllTeamMembers();

  const paths = await Promise.all(
    members.map(async (member) => {
      const fullMember = await getTeamMemberBySlug(member.slug.current);
      return {
        params: { slug: member.slug.current },
        props: { member: fullMember },
      };
    })
  );

  return paths;
}

const { member } = Astro.props;

// Handle null member
if (!member) {
  return Astro.redirect('/about');
}

// Generate initials from name for fallback
const initials = member.name
  .split(' ')
  .map((word: string) => word[0])
  .join('')
  .toUpperCase()
  .slice(0, 2);

// Render portable text to HTML (escape text for XSS safety)
function renderPortableText(blocks: any[]) {
  if (!blocks) return '';
  return blocks
    .map((block) => {
      if (block._type === 'block') {
        let content = block.children
          .map((child: any) => {
            let text = escapeHtml(child.text || '');
            if (child.marks && child.marks.length > 0) {
              child.marks.forEach((mark: string) => {
                if (mark === 'strong') {
                  text = '<strong>' + text + '</strong>';
                } else if (mark === 'em') {
                  text = '<em>' + text + '</em>';
                }
              });
            }
            return text;
          })
          .join('');

        const style = block.style || 'normal';
        if (style === 'h2') return '<h2 class="text-2xl font-heading font-bold text-charcoal mt-8 mb-4">' + content + '</h2>';
        if (style === 'h3') return '<h3 class="text-xl font-heading font-semibold text-charcoal mt-6 mb-3">' + content + '</h3>';
        return '<p class="text-gray-700 leading-relaxed mb-4">' + content + '</p>';
      }
      return '';
    })
    .join('');
}

const bioHtml = member.bio ? renderPortableText(member.bio) : '';
---

<BaseLayout
  title={`${member.name} - ${member.role}`}
  description={member.shortBio || `Learn more about ${member.name}, ${member.role} at Acupuncture & Holistic Health Associates.`}
>
  <!-- Hero Section -->
  <section class="relative bg-gradient-to-br from-sage-50 to-warm-white py-16 md:py-20">
    <Container>
      <div class="mb-6">
        <a href="/about" class="inline-flex items-center gap-2 text-sage-600 hover:text-sage-700 font-medium transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to About Us
        </a>
      </div>

      <div class="grid lg:grid-cols-3 gap-12 items-start">
        <!-- Left: Photo and Quick Info -->
        <div class="lg:col-span-1">
          <Card variant="elevated" padding="lg" class="text-center sticky top-8">
            {member.photo ? (
              <SanityImage
                image={member.photo}
                alt={member.name}
                width={300}
                height={300}
                aspectRatio="1/1"
                class="w-48 h-48 mx-auto mb-6 rounded-full shadow-lg"
                sizes="192px"
                quality={85}
              />
            ) : (
              <div class="w-48 h-48 mx-auto mb-6 rounded-full bg-gradient-to-br from-sage-200 to-healing-blue flex items-center justify-center shadow-lg">
                <span class="text-6xl font-heading font-bold text-sage-700">{initials}</span>
              </div>
            )}

            <h1 class="text-2xl font-heading font-bold text-charcoal mb-2">{member.name}</h1>
            <p class="text-sage-600 font-semibold mb-4">{member.role}</p>

            {/* Credentials and Experience */}
            <div class="flex flex-wrap gap-2 justify-center mb-6">
              {member.credentials && (
                <Badge variant="info" size="md">{member.credentials}</Badge>
              )}
              {member.yearsExperience && (
                <Badge variant="default" size="md">{member.yearsExperience}+ Years</Badge>
              )}
            </div>

            {/* Languages */}
            {member.languages && member.languages.length > 0 && (
              <div class="flex items-center justify-center gap-2 text-sm text-gray-600 mb-6">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                </svg>
                <span>{member.languages.join(', ')}</span>
              </div>
            )}

            {/* Contact Info */}
            <div class="space-y-3 mb-6 text-sm">
              {member.email && (
                <a href={`mailto:${member.email}`} class="flex items-center justify-center gap-2 text-gray-600 hover:text-sage-600 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  <span>{member.email}</span>
                </a>
              )}
              {member.phone && (
                <a href={`tel:${member.phone.replace(/[^0-9]/g, '')}`} class="flex items-center justify-center gap-2 text-gray-600 hover:text-sage-600 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                  <span>{member.phone}</span>
                </a>
              )}
            </div>

            <Button
              variant="primary"
              size="md"
              icon="calendar"
              href={JANE_BOOKING_URL}
              target="_blank"
              rel="noopener noreferrer"
              class="w-full justify-center"
            >
              Book Appointment
            </Button>
          </Card>
        </div>

        <!-- Right: Bio and Details -->
        <div class="lg:col-span-2 space-y-8">
          {/* Short Bio */}
          {member.shortBio && (
            <Card variant="bordered" padding="lg">
              <p class="text-lg text-gray-700 leading-relaxed italic">
                "{member.shortBio}"
              </p>
            </Card>
          )}

          {/* Full Bio */}
          {bioHtml && (
            <div>
              <h2 class="text-2xl font-heading font-bold text-charcoal mb-6">About {member.name.split(' ')[0]}</h2>
              <div class="prose prose-lg max-w-none" set:html={bioHtml} />
            </div>
          )}

          {/* Specialties */}
          {member.specialties && member.specialties.length > 0 && (
            <Card variant="bordered" padding="lg">
              <h2 class="text-xl font-heading font-semibold text-charcoal mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-sage-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                  <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"></path>
                </svg>
                Areas of Specialization
              </h2>
              <div class="flex flex-wrap gap-2">
                {member.specialties.map((specialty: string) => (
                  <Badge variant="default" size="md">{specialty}</Badge>
                ))}
              </div>
            </Card>
          )}

          {/* Education */}
          {member.education && member.education.length > 0 && (
            <Card variant="bordered" padding="lg">
              <h2 class="text-xl font-heading font-semibold text-charcoal mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-sage-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"></path>
                </svg>
                Education
              </h2>
              <ul class="space-y-3">
                {member.education.map((edu: { degree: string; school: string; year: number }) => (
                  <li class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-sage-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <div>
                      <div class="font-medium text-charcoal">{edu.degree}</div>
                      <div class="text-sm text-gray-600">{edu.school} {edu.year && `(${edu.year})`}</div>
                    </div>
                  </li>
                ))}
              </ul>
            </Card>
          )}

          {/* Certifications */}
          {member.certifications && member.certifications.length > 0 && (
            <Card variant="bordered" padding="lg">
              <h2 class="text-xl font-heading font-semibold text-charcoal mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-sage-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                </svg>
                Certifications & Licenses
              </h2>
              <ul class="space-y-3">
                {member.certifications.map((cert: { title: string; organization: string; year: number }) => (
                  <li class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-sage-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <div>
                      <div class="font-medium text-charcoal">{cert.title}</div>
                      <div class="text-sm text-gray-600">{cert.organization} {cert.year && `(${cert.year})`}</div>
                    </div>
                  </li>
                ))}
              </ul>
            </Card>
          )}
        </div>
      </div>
    </Container>
  </section>

  <!-- CTA Section -->
  <section class="py-16 md:py-20 bg-gradient-to-br from-sage-600 to-sage-700 text-white">
    <Container class="text-center">
      <h2 class="text-3xl md:text-4xl font-heading font-bold mb-4">
        Ready to Book an Appointment?
      </h2>
      <p class="text-lg mb-8 max-w-2xl mx-auto opacity-90">
        Schedule a consultation with {member.name.split(' ')[0]} today and take the first step towards better health.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <Button variant="secondary" size="lg" icon="calendar" href={JANE_BOOKING_URL} target="_blank" rel="noopener noreferrer">
          Book Appointment
        </Button>
        <Button variant="outline" size="lg" icon="phone" href={`tel:${CONTACT.phone.replace(/[^0-9]/g, '')}`}>
          Call {CONTACT.phone}
        </Button>
      </div>
    </Container>
  </section>
</BaseLayout>
