---
import logo from '../assets/logo.png';
import Navigation from './Navigation.astro';
import Button from './Button.astro';
import SearchModal from './SearchModal.astro';
import { JANE_BOOKING_URL } from '../lib/config';

// Ensure logo URL is root-relative so it works on all routes (e.g. /blog, /blog/slug)
const logoSrc = typeof logo === 'object' && logo?.src != null ? logo.src : String(logo);
const rootRelativeLogoSrc = logoSrc.startsWith('/') ? logoSrc : `/${logoSrc}`;
---

<header
  id="header"
  class="sticky top-0 z-50 bg-white/95 backdrop-blur-sm shadow-sm transition-all duration-300"
  data-pagefind-ignore
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-20 gap-8">
      <!-- Logo/Brand -->
      <a
        href="/"
        class="flex items-center gap-2 text-sm sm:text-base font-heading font-bold text-sage-700 hover:text-sage-600 transition-colors"
      >
        <picture>
          <source type="image/webp" srcset="/logo.webp" />
          <img src={rootRelativeLogoSrc} alt="Acupuncture & Holistic Health Associates logo" width={40} height={40} class="h-10 w-auto shrink-0" />
        </picture>
        <span class="hidden sm:inline leading-tight">Acupuncture &<br/>Holistic Health Associates</span>
        <span class="sm:hidden">AHH Associates</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center gap-6">
        <Navigation />

        <!-- Search -->
        <SearchModal />

        <!-- CTA Button -->
        <Button variant="primary" size="md" icon="calendar" href={JANE_BOOKING_URL} target="_blank" rel="noopener noreferrer">
          Book Appointment
        </Button>
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-toggle"
        class="lg:hidden p-2 text-sage-700 hover:text-sage-600 transition-colors"
        aria-label="Toggle mobile menu"
        aria-expanded="false"
      >
        <svg id="menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
        <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>
</header>

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-40 bg-warm-white/95 backdrop-blur-md opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24">
    <nav class="flex flex-col gap-4">
      <a href="/" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        Home
      </a>
      <a href="/about" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        About Us
      </a>
      <a href="/services" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        Services
      </a>
      <a href="/conditions" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        Conditions We Treat
      </a>
      <a href="/acupuncture" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        About Acupuncture
      </a>
      <a href="/reviews" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        Reviews
      </a>
      <a href="/blog" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        Blog
      </a>
      <a href="/faq" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        FAQ
      </a>
      <a href="/contact" class="text-2xl font-heading font-semibold text-sage-700 hover:text-sage-600 transition-colors py-2">
        Contact
      </a>

      <!-- Mobile CTA -->
      <div class="mt-6">
        <Button variant="primary" size="lg" icon="calendar" href={JANE_BOOKING_URL} target="_blank" rel="noopener noreferrer" class="w-full justify-center">
          Book Appointment
        </Button>
      </div>
    </nav>
  </div>
</div>

<script>
  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');

  if (mobileMenuToggle && mobileMenu && menuIcon && closeIcon) {
    mobileMenuToggle.addEventListener('click', () => {
      const isOpen = mobileMenu.classList.contains('opacity-100');

      if (isOpen) {
        // Close menu
        mobileMenu.classList.remove('opacity-100', 'pointer-events-auto');
        mobileMenu.classList.add('opacity-0', 'pointer-events-none');
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        mobileMenuToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = 'auto';
      } else {
        // Open menu
        mobileMenu.classList.remove('opacity-0', 'pointer-events-none');
        mobileMenu.classList.add('opacity-100', 'pointer-events-auto');
        menuIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
        mobileMenuToggle.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }
    });

    // Close menu when clicking a link
    const mobileLinks = mobileMenu.querySelectorAll('a');
    mobileLinks.forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.remove('opacity-100', 'pointer-events-auto');
        mobileMenu.classList.add('opacity-0', 'pointer-events-none');
        menuIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        mobileMenuToggle.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = 'auto';
      });
    });
  }

  // Header scroll effect: use rAF to avoid forced reflow (read scrollY + write class in same frame)
  const header = document.getElementById('header');
  let scrollTicking = false;

  if (header) {
    window.addEventListener('scroll', () => {
      if (scrollTicking) return;
      scrollTicking = true;
      requestAnimationFrame(() => {
        const currentScroll = window.scrollY;
        if (currentScroll > 100) {
          header.classList.add('shadow-md');
        } else {
          header.classList.remove('shadow-md');
        }
        scrollTicking = false;
      });
    }, { passive: true });
  }
</script>
